<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Academic Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Global Styles - UNCHANGED */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --accent: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4cc9f0;
            --warning: #f72585;
            --info: #7209b7;
            --gradient: linear-gradient(135deg, #4361ee, #3a0ca3);
            --sidebar-width: 300px;
        }

        body {
            background-color: #f5f7fb;
            color: var(--dark);
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Sidebar Styles - UNCHANGED */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            overflow-y: auto;
            transition: transform 0.3s ease;
            display: none; 
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .nav-menu {
            list-style: none;
            padding: 20px 0;
        }

        .nav-item {
            margin-bottom: 5px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            text-decoration: none;
            color: var(--dark);
            font-weight: 600;
            transition: background 0.3s ease, color 0.3s ease;
            border-left: 3px solid transparent;
        }

        .nav-link:hover, .nav-link.active {
            background: #f8f9fa;
            color: var(--primary);
            border-left-color: var(--primary);
        }
        
        /* Logout Button - UNCHANGED */
        .logout-btn {
            margin-top: auto;
            padding: 12px 20px;
            width: 100%;
            text-align: left;
            background: none;
            border: none;
            color: var(--warning);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.3s ease;
        }

        .logout-btn:hover {
            background: #f8d7da;
        }

        /* Main Content & Header - UNCHANGED */
        .main-content {
            margin-left: var(--sidebar-width);
            transition: margin-left 0.3s ease;
        }

        .header {
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        /* Mobile Responsiveness - UNCHANGED */
        .menu-toggle {
            display: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--dark);
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .menu-toggle {
                display: block;
            }

            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
                opacity: 0;
                visibility: hidden;
                transition: opacity 0.3s ease;
            }

            .sidebar-overlay.open {
                opacity: 1;
                visibility: visible;
            }
        }

        /* Buttons, Cards, Forms - UNCHANGED */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(67, 97, 238, 0.3);
        }

        .btn-secondary {
            background-color: var(--light);
            color: var(--dark);
            border: 1px solid #dee2e6;
        }

        .btn-secondary:hover {
            background-color: #e9ecef;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.9rem;
            margin-left: 5px;
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .btn-warning:hover {
             background-color: #d40d6c;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            padding: 24px;
            margin-bottom: 24px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
            outline: none;
        }

        /* Students Table - UNCHANGED */
        .students-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            overflow-x: auto;
            display: block;
        }

        .students-table th, .students-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            white-space: nowrap;
        }

        .students-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        /* Welcome Screen - UNCHANGED */
        #welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            transition: opacity 1s ease, visibility 1s ease;
        }

        .welcome-logo {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        .welcome-title {
            font-size: 3rem;
            margin-bottom: 10px;
            text-align: center;
            animation: fadeInDown 1s ease;
        }

        .welcome-subtitle {
            font-size: 1.5rem;
            margin-bottom: 40px;
            text-align: center;
            animation: fadeInUp 1s ease;
        }

        .welcome-progress {
            width: 300px;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .welcome-progress-bar {
            height: 100%;
            background: white;
            width: 0%;
            animation: progress 3s ease-in-out forwards;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes progress {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        /* ------------------------------------------
           MODIFIED LOGIN PAGE STYLES
           ------------------------------------------
        */
        
        #login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            background: var(--gradient);
        }

        .auth-card {
            width: 100%;
            max-width: 550px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            padding: 40px;
            overflow: hidden;
        }
        
        .auth-header {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary);
        }
        
        .auth-header i {
            font-size: 3rem;
            margin-bottom: 10px;
            display: block;
            animation: pulse 2.5s infinite ease-in-out;
        }
        
        .auth-header h3 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--dark);
        }

        .login-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #dee2e6;
            justify-content: center;
        }
        
        .login-tab {
            padding: 12px 24px;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            flex-grow: 1;
            text-align: center;
        }

        .login-tab:hover {
            color: var(--primary);
        }

        .login-tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }
        
        .auth-container {
            display: none;
        }
        
        .auth-container.active {
            display: block;
        }

        .auth-actions {
            display: none;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
            animation: fadeIn 0.5s ease;
        }
        
        .auth-actions.active {
            display: flex;
        }

        .auth-actions .btn {
            width: 100%; 
            padding: 15px;
            font-size: 1.1rem;
        }
        
        .login-form {
            display: none;
            animation: fadeIn 0.5s ease;
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .login-form::-webkit-scrollbar {
            width: 8px;
        }
        .login-form::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .login-form::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 10px;
        }
        .login-form::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }

        .login-form.active {
            display: block;
        }
        
        .btn-back {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 12px;
            font-size: 0.9rem;
            margin-bottom: 15px;
            background: none;
            border: none;
            color: var(--dark);
            cursor: pointer;
        }
        
        .btn-back:hover {
            color: var(--primary);
            text-decoration: underline;
        }

        @media (max-width: 600px) {
            .auth-card {
                padding: 30px 25px;
            }
            .login-form {
                max-height: 75vh;
            }
            .auth-header {
                margin-bottom: 20px;
            }
            .auth-header i {
                font-size: 2.5rem;
            }
            .auth-header h3 {
                font-size: 1.5rem;
            }
        }

        /* ------------------------------------------
           END OF MODIFIED LOGIN STYLES
           ------------------------------------------
        */

        /* Page Styles - UNCHANGED */
        #dashboard {
            display: none;
        }

        .page-content {
            padding: 40px 0;
            min-height: calc(100vh - 80px); /* Adjusted for header */
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 2.2rem;
            margin-bottom: 10px;
            color: var(--dark);
        }

        .page-subtitle {
            font-size: 1.1rem;
            color: #6c757d;
        }

        /* Home Page Hero/Features - UNCHANGED */
        .hero-section {
            background: var(--gradient);
            color: white;
            padding: 60px 0;
            border-radius: 16px;
            margin-bottom: 40px;
            text-align: center;
        }

        .hero-title {
            font-size: 2.5rem;
            margin-bottom: 20px;
        }

        .hero-subtitle {
            font-size: 1.2rem;
            margin-bottom: 30px;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-top: 40px;
        }

        .feature-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }

        .feature-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            color: var(--primary);
        }

        .feature-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .feature-description {
            color: #6c757d;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .features-grid {
                grid-template-columns: 1fr;
            }
            
            .hero-title {
                font-size: 2rem;
            }
        }

        /* Page Display - UNCHANGED */
        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ------------------------------------------
        NEW & MODIFIED STYLES
        ------------------------------------------
        */

        /* Helper for empty states */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        /* Upload Card for Students (Projects, Sports, etc.) */
        .upload-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .upload-card-header {
            font-size: 1.3rem;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .upload-area {
            position: relative;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s ease, background 0.3s ease;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: #f8f9fa;
        }
        
        .upload-area input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 10;
        }

        .upload-icon {
            font-size: 3rem;
            color: #6c757d;
            margin-bottom: 15px;
        }

        /* File List for displaying uploads */
        .file-list {
            list-style: none;
            margin-top: 20px;
        }
        
        .file-list-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        
        .file-info i {
            color: var(--primary);
        }
        
        .file-date {
            font-size: 0.9rem;
            color: #6c757d;
        }

        /* MODIFIED: Table for materials (used by students and faculty) */
        .materials-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            overflow-x: auto;
            display: block;
        }
        
        .materials-table th, .materials-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            white-space: nowrap;
        }
        
        .materials-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .materials-table .file-note {
            white-space: pre-wrap;
            min-width: 150px;
        }

        /* Assignment Table (Student) */
        .assignment-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            overflow-x: auto;
            display: block;
        }
        
        .assignment-table th, .assignment-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        .assignment-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .assignment-desc {
            max-width: 300px;
            white-space: pre-wrap; /* Show newlines from faculty */
        }
        
        .assignment-file a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }
        
        .assignment-file a:hover {
            text-decoration: underline;
        }
        
        /* NEW: Cell for action buttons */
        .materials-table .actions-cell,
        .assignment-table .actions-cell {
            white-space: nowrap;
            width: 1%;
        }

        /* Reminder Card */
        .reminder-card {
            background: white;
            border-left: 5px solid var(--info);
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .reminder-body {
            font-size: 1rem;
            margin-bottom: 10px;
        }
        
        .reminder-footer {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .reminder-deadline {
            font-weight: 600;
            color: var(--warning);
        }

        /* Toast Notification */
        #toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--dark);
            color: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 10001;
            transform: translateX(120%);
            transition: transform 0.5s ease-in-out;
        }
        
        #toast-notification.show {
            transform: translateX(0);
        }
        
        .toast-header {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        /* ------------------------------------------
        NEW MARKLIST STYLES
        ------------------------------------------
        */
        
        /* Faculty mark input */
        .mark-input {
            width: 100px; /* Give a fixed width */
            text-align: center;
            padding: 8px 10px; /* Smaller padding for table */
        }
        
        /* Student mark list */
        .mark-list {
            list-style: none;
            padding: 0;
            margin-top: 15px;
        }
        
        .mark-list li {
            font-size: 1.1rem;
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .mark-list li:last-child {
            border-bottom: none;
        }
        
        .mark-list li strong {
            color: var(--dark);
        }
        
        .mark-list li span {
            font-weight: 600;
            color: var(--primary);
        }
    </style>
</head>
<body>
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-graduation-cap"></i>
            <span class="logo">Academic Portal</span>
        </div>
        <ul class="nav-menu" id="nav-menu">
            </ul>
        <button class="logout-btn" id="logout-btn" style="display: none;">
            <i class="fas fa-sign-out-alt"></i>
            Logout
        </button>
    </nav>

    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <div id="dashboard">
        <header class="header">
            <div class="menu-toggle" id="menu-toggle">
                <i class="fas fa-bars"></i>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">JS</div>
                <span id="user-name">John Student</span>
            </div>
        </header>

        <div class="main-content">
            <div class="container">
                <div class="page-content">
                    
                    <div id="home-page" class="page active">
                        <div class="page-header">
                            <h1 class="page-title">Welcome to Your Academic Portal</h1>
                            <p class="page-subtitle">Your one-stop solution for all academic needs</p>
                        </div>
                        
                        <div class="hero-section">
                            <h2 class="hero-title">Empowering Your Academic Journey</h2>
                            <p class="hero-subtitle">Access all your academic resources, track your progress, and stay organized with our comprehensive portal.</p>
                        </div>
                        
                        <div class="features-grid">
                            <div class="feature-card">
                                <div class="feature-icon">
                                    <i class="fas fa-book-open"></i>
                                </div>
                                <h3 class="feature-title">Study Materials</h3>
                                <p class="feature-description">Access all your subject materials, notes, and resources in one place.</p>
                            </div>
                            <div class="feature-card">
                                <div class="feature-icon">
                                    <i class="fas fa-tasks"></i>
                                </div>
                                <h3 class="feature-title">Assignments</h3>
                                <p class="feature-description">Submit and track your assignments and get feedback from faculty.</p>
                            </div>
                            <div class="feature-card">
                                <div class="feature-icon">
                                    <i class="fas fa-project-diagram"></i>
                                </div>
                                <h3 class="feature-title">Project Management</h3>
                                <p class="feature-description">Submit and track your academic projects with dedicated resources.</p>
                            </div>
                            <div class="feature-card">
                                <div class="feature-icon">
                                    <i class="fas fa-bell"></i>
                                </div>
                                <h3 class="feature-title">Smart Reminders</h3>
                                <p class="feature-description">Never miss an assignment deadline or important academic event.</p>
                            </div>
                        </div>
                    </div>

                    <div id="reminders-page" class="page">
                        </div>

                    <div id="subjects-page" class="page">
                        </div>

                    <div id="laboratory-page" class="page">
                        </div>

                    <div id="projects-page" class="page">
                        </div>

                    <div id="assignments-page" class="page">
                        </div>

                    <div id="attendance-page" class="page">
                        <div class="page-header">
                            <h1 class="page-title">Attendance</h1>
                            <p class="page-subtitle">Simulated attendance tracker</p>
                        </div>
                        <div class="card">
                            <h3>Attendance Simulator</h3>
                            <p>This is a placeholder for a simulated attendance module as requested.</p>
                            <div style="margin-top: 20px;">
                                <h4>Your Overall Attendance: <strong>85%</strong></h4>
                                <div class="welcome-progress" style="width: 100%; background: #eee;">
                                    <div class="welcome-progress-bar" style="width: 85%; background: var(--gradient); animation: none;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="co-curricular-page" class="page">
                        </div>

                    <div id="sports-page" class="page">
                        </div>

                    <div id="students-page" class="page">
                        <div class="page-header">
                            <h1 class="page-title">Batch Students</h1>
                            <p class="page-subtitle" id="students-page-subtitle">View students in your batch who are taking your subject</p>
                        </div>
                        <div class="card">
                            <table class="students-table">
                                <thead>
                                    <tr>
                                        <th>S.No</th>
                                        <th>Roll No</th>
                                        <th>Age</th>
                                        <th>Blood Group</th>
                                        <th>Batch</th>
                                        <th>Year</th>
                                        <th>Semester</th>
                                        <th>Mobile</th>
                                        <th>Address</th>
                                    </tr>
                                </thead>
                                <tbody id="students-tbody">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="marklist-page" class="page">
                        </div>
                    </div>
            </div>
        </div>
    </div>

    <div id="login-page">
        <div class="auth-card">
            
            <div class="auth-header">
                <i class="fas fa-graduation-cap"></i>
                <h3>Academic Portal</h3>
            </div>
            
            <div class="login-tabs">
                <div class="login-tab active" data-tab="student">Student</div>
                <div class="login-tab" data-tab="faculty">Faculty</div>
            </div>
            
            <div id="student-auth" class="auth-container active">
                
                <div class="auth-actions active" id="student-auth-actions">
                    <button class="btn btn-primary" id="student-show-login-btn">
                        <i class="fas fa-sign-in-alt"></i> Student Login
                    </button>
                    <button class="btn btn-secondary" id="student-show-register-btn">
                        <i class="fas fa-user-plus"></i> Student Register
                    </button>
                </div>
                
                <form id="student-login-form" class="login-form" onsubmit="return false;">
                    <button type="button" class="btn-back" data-role="student">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <h2 style="margin-bottom: 20px;">Student Login</h2>
                    <div class="form-group">
                        <label class="form-label" for="login-reg-no">Registration Number (Roll No)</label>
                        <input type="text" class="form-control" id="login-reg-no" placeholder="Enter your roll number" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="login-password">Password</label>
                        <input type="password" class="form-control" id="login-password" placeholder="Enter your password" required>
                    </div>
                    <button type="button" class="btn btn-primary" style="width: 100%; margin-top: 20px;" id="student-login-btn">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                </form>
                
                <form id="student-register-form" class="login-form" onsubmit="return false;">
                    <button type="button" class="btn-back" data-role="student">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <h2 style="margin-bottom: 20px;">Student Registration</h2>
                    
                    <div class="form-group">
                        <label class="form-label" for="name">Full Name</label>
                        <input type="text" class="form-control" id="name" placeholder="Enter your full name" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="reg-no">Registration Number (Roll No)</label>
                        <input type="text" class="form-control" id="reg-no" placeholder="Enter your roll number" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="college">College Name</label>
                        <input type="text" class="form-control" id="college" placeholder="Enter your college name" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="department">Department</label>
                        <select class="form-control" id="department" required>
                            <option value="">Select Department</option>
                            <option value="CSE">Computer Science and Engineering (CSE)</option>
                            <option value="ECE">Electronics and Communication Engineering (ECE)</option>
                            <option value="ME">Mechanical Engineering</option>
                            <option value="EEE">Electrical and Electronics Engineering (EEE)</option>
                            <option value="CE">Civil Engineering</option>
                            <option value="IT">Information Technology (IT)</option>
                            <option value="AI">Artificial Intelligence (AI) and Machine Learning (ML)</option>
                            <option value="RA">Robotics and Automation</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="batch">Batch</label>
                        <input type="text" class="form-control" id="batch" placeholder="Enter your batch (e.g., 2023-2027)" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="semester">Current Semester</label>
                        <select class="form-control" id="semester" required>
                            <option value="">Select Semester</option>
                            <option value="1">Semester 1</option>
                            <option value="2">Semester 2</option>
                            <option value="3">Semester 3</option>
                            <option value="4">Semester 4</option>
                            <option value="5">Semester 5</option>
                            <option value="6">Semester 6</option>
                            <option value="7">Semester 7</option>
                            <option value="8">Semester 8</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="dob">Date of Birth</label>
                        <input type="date" class="form-control" id="dob" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="blood-group">Blood Group</label>
                        <select class="form-control" id="blood-group" required>
                            <option value="">Select Blood Group</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="mobile">Mobile Number</label>
                        <input type="tel" class="form-control" id="mobile" placeholder="Enter 10-digit mobile number" pattern="[0-9]{10}" maxlength="10" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="district">District</label>
                        <input type="text" class="form-control" id="district" placeholder="Enter your district" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="pincode">PIN Code</label>
                        <input type="text" class="form-control" id="pincode" placeholder="Enter your PIN code" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="address">Full Address</label>
                        <textarea class="form-control" id="address" placeholder="Enter full address (house, street, city, state)" rows="3" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="subject-count">Number of Subjects</label>
                        <input type="number" class="form-control" id="subject-count" min="1" max="10" placeholder="Enter number of subjects" required>
                    </div>
                    
                    <div id="subjects-container"></div>
                    
                    <div class="form-group">
                        <label class="form-label" for="reg-password">Set Password</label>
                        <input type="password" class="form-control" id="reg-password" placeholder="Set your password" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="reg-confirm-password">Confirm Password</label>
                        <input type="password" class="form-control" id="reg-confirm-password" placeholder="Confirm your password" required>
                    </div>
                    
                    <button type="button" class="btn btn-primary" style="width: 100%; margin-top: 20px;" id="student-register-btn">
                        <i class="fas fa-user-plus"></i> Register & Continue
                    </button>
                </form>
            </div>

            <div id="faculty-auth" class="auth-container">
                
                <div class="auth-actions active" id="faculty-auth-actions">
                    <button class="btn btn-primary" id="faculty-show-login-btn">
                        <i class="fas fa-sign-in-alt"></i> Faculty Login
                    </button>
                    <button class="btn btn-secondary" id="faculty-show-register-btn">
                        <i class="fas fa-user-plus"></i> Faculty Register
                    </button>
                </div>
                
                <form id="faculty-login-form" class="login-form" onsubmit="return false;">
                    <button type="button" class="btn-back" data-role="faculty">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <h2 style="margin-bottom: 20px;">Faculty Login</h2>
                    <div class="form-group">
                        <label class="form-label" for="faculty-login-name">Full Name</label>
                        <input type="text" class="form-control" id="faculty-login-name" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="faculty-login-password">Password</label>
                        <input type="password" class="form-control" id="faculty-login-password" placeholder="Enter your password" required>
                    </div>
                    <button type="button" class="btn btn-primary" style="width: 100%;" id="faculty-login-btn">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                </form>
                
                <form id="faculty-register-form" class="login-form" onsubmit="return false;">
                    <button type="button" class="btn-back" data-role="faculty">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <h2 style="margin-bottom: 20px;">Faculty Registration</h2>
                    
                    <div class="form-group">
                        <label class="form-label" for="faculty-name">Full Name</label>
                        <input type="text" class="form-control" id="faculty-name" placeholder="Enter your full name" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="faculty-email">Email ID</label>
                        <input type="email" class="form-control" id="faculty-email" placeholder="Enter your email" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="faculty-mobile">Mobile Number</label>
                        <input type="tel" class="form-control" id="faculty-mobile" placeholder="Enter 10-digit mobile number" pattern="[0-9]{10}" maxlength="10" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="faculty-department">Department</label>
                        <select class="form-control" id="faculty-department" required>
                            <option value="">Select Department</option>
                            <option value="CSE">Computer Science and Engineering (CSE)</option>
                            <option value="ECE">Electronics and Communication Engineering (ECE)</option>
                            <option value="ME">Mechanical Engineering</option>
                            <option value="EEE">Electrical and Electronics Engineering (EEE)</option>
                            <option value="CE">Civil Engineering</option>
                            <option value="IT">Information Technology (IT)</option>
                            <option value="AI">Artificial Intelligence (AI) and Machine Learning (ML)</option>
                            <option value="RA">Robotics and Automation</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="faculty-batch">Batch Handled</label>
                        <input type="text" class="form-control" id="faculty-batch" placeholder="Enter batch (e.g., 2023-2027)" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="faculty-subject">Subject for This Semester</label>
                        <input type="text" class="form-control" id="faculty-subject" placeholder="Enter subject name (e.g., Data Structures, Project Work)" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="faculty-reg-password">Set Password</label>
                        <input type="password" class="form-control" id="faculty-reg-password" placeholder="Set your password" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="faculty-reg-confirm-password">Confirm Password</label>
                        <input type="password" class="form-control" id="faculty-reg-confirm-password" placeholder="Confirm your password" required>
                    </div>
                    
                    <button type="button" class="btn btn-primary" style="width: 100%;" id="faculty-register-btn">
                        <i class="fas fa-user-plus"></i> Register
                    </button>
                </form>
            </div>
            
        </div>
    </div>
    <div id="welcome-screen">
        <div class="welcome-logo">
            <i class="fas fa-graduation-cap"></i>
        </div>
        <h1 class="welcome-title">Student Academic Portal</h1>
        <p class="welcome-subtitle">Your gateway to academic excellence</p>
        <div class="welcome-progress">
            <div class="welcome-progress-bar"></div>
        </div>
        <p>Loading amazing features...</p>
    </div>

    <div id="toast-notification">
        <div class="toast-header"><i class="fas fa-bell"></i> New Reminder</div>
        <div class="toast-body" id="toast-body">This is a reminder message!</div>
    </div>


    <script>
        // ----------------------------------------------------
        // RE-MASTERED SCRIPT - ALL LOGIC IS REBUILT
        // ----------------------------------------------------

        let currentUser = null;
        let userRole = null; // 'student' or 'faculty'

        // All data is "synced" using localStorage
        // Helper function to get/set local storage data
        const db = {
            get: (key) => JSON.parse(localStorage.getItem(key) || '[]'),
            set: (key, data) => localStorage.setItem(key, JSON.stringify(data))
        };

        // Welcome Animation
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                const welcome = document.getElementById('welcome-screen');
                welcome.style.opacity = '0';
                welcome.style.visibility = 'hidden';
            }, 3500);
            
            restoreSession();
            
            // Initial setup for NEW button-based login
            setupLoginListeners();
        });

        // Restore Session
        function restoreSession() {
            const storedUser = localStorage.getItem('currentUser');
            const storedRole = localStorage.getItem('userRole');
            if (storedUser && storedRole) {
                currentUser = JSON.parse(storedUser);
                userRole = storedRole;
                showDashboard(currentUser, userRole);
            }
        }

        // Show Dashboard
        function showDashboard(user, role) {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('user-name').textContent = user.name || user.facultyName;
            
            const initials = (user.name || user.facultyName).split(' ').map(n => n[0]).join('').toUpperCase();
            document.getElementById('user-avatar').textContent = initials.substring(0, 2);
            
            document.getElementById('sidebar').style.display = 'block';
            document.getElementById('logout-btn').style.display = 'block';
            
            populateNav(role, user);
            
            // Navigate to home page by default
            navigateToPage('home');

            if (role === 'student') {
                checkReminders(user);
            }
        }

        // ------------------------------------------
        // DYNAMIC NAVIGATION
        // ------------------------------------------
        function populateNav(role, user) {
            const navMenu = document.getElementById('nav-menu');
            navMenu.innerHTML = ''; // Clear existing nav

            // Common Link
            navMenu.innerHTML += `
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-page="home">
                        <i class="fas fa-home"></i> Home
                    </a>
                </li>
            `;

            if (role === 'student') {
                navMenu.innerHTML += `
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="subjects">
                            <i class="fas fa-book-open"></i> Subjects
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="attendance">
                            <i class="fas fa-calendar-check"></i> Attendance
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="laboratory">
                            <i class="fas fa-flask"></i> Laboratory
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="projects">
                            <i class="fas fa-project-diagram"></i> Projects
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="co-curricular">
                            <i class="fas fa-music"></i> Co-curricular
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="sports">
                            <i class="fas fa-running"></i> Sports
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="assignments">
                            <i class="fas fa-tasks"></i> Assignments
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="marklist">
                            <i class="fas fa-clipboard-list"></i> Marklist
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="reminders">
                            <i class="fas fa-bell"></i> Reminders
                        </a>
                    </li>
                `;
            } else if (role === 'faculty') {
                navMenu.innerHTML += `
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="subjects">
                            <i class="fas fa-book"></i> Subjects Info
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="students">
                            <i class="fas fa-users"></i> Students
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="marklist">
                            <i class="fas fa-clipboard-list"></i> Marklist
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="assignments">
                            <i class="fas fa-tasks"></i> Assignments
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="reminders">
                            <i class="fas fa-bell"></i> Reminders
                        </a>
                    </li>
                `;

                // *** MODIFIED LOGIC ***
                // Conditional: Show Laboratory
                const students = db.get('studentsData');
                const facultySubjectName = user.facultySubject.toLowerCase();
                let facultySubjectType = 'theory'; // Default
                
                // Find the subject type from any student in the batch
                const matchingStudentSubject = students
                    .find(s => s.batch === user.facultyBatch && s.department === user.facultyDepartment)
                    ?.subjects.find(sub => sub.name.toLowerCase() === facultySubjectName);
                    
                if (matchingStudentSubject) {
                    facultySubjectType = matchingStudentSubject.type;
                }

                // Show Lab nav only if the faculty's subject is a lab subject
                if (facultySubjectType === 'practical' || facultySubjectType === 'theory+practical') {
                    navMenu.innerHTML += `
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-page="laboratory">
                                <i class="fas fa-flask"></i> Laboratory
                            </a>
                        </li>
                    `;
                }
                
                // Conditional: Show Projects
                // Show Project nav only if the faculty's subject is a project subject
                if (facultySubjectType === 'coding+project' || facultySubjectName.includes('project')) {
                    navMenu.innerHTML += `
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-page="projects">
                                <i class="fas fa-project-diagram"></i> Projects
                            </a>
                        </li>
                    `;
                }
            }
            
            attachNavListeners();
        }

        // ------------------------------------------
        // LOGIN / REGISTRATION LOGIC - CORRECTED
        // ------------------------------------------
        
        function setupLoginListeners() {
            // Main Tabs (Student/Faculty)
            document.querySelectorAll('.login-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Toggle auth containers
                    document.querySelectorAll('.auth-container').forEach(c => c.classList.remove('active'));
                    const tabName = this.getAttribute('data-tab');
                    document.getElementById(`${tabName}-auth`).classList.add('active');
                    
                    // IMPORTANT: Reset to button view
                    resetAuthForms(tabName);
                });
            });

            // --- Show Form Buttons ---
            // Student
            document.getElementById('student-show-login-btn').addEventListener('click', () => showAuthForm('student', 'login'));
            document.getElementById('student-show-register-btn').addEventListener('click', () => showAuthForm('student', 'register'));
            
            // Faculty
            document.getElementById('faculty-show-login-btn').addEventListener('click', () => showAuthForm('faculty', 'login'));
            document.getElementById('faculty-show-register-btn').addEventListener('click', () => showAuthForm('faculty', 'register'));

            // --- Back Buttons ---
            document.querySelectorAll('.btn-back').forEach(btn => {
                btn.addEventListener('click', function() {
                    const role = this.getAttribute('data-role');
                    resetAuthForms(role);
                });
            });
            
            // --- Form Submission Buttons ---
            document.getElementById('student-login-btn').addEventListener('click', handleStudentLogin);
            document.getElementById('student-register-btn').addEventListener('click', handleStudentRegister);
            document.getElementById('faculty-login-btn').addEventListener('click', handleFacultyLogin);
            document.getElementById('faculty-register-btn').addEventListener('click', handleFacultyRegister);
        }
        
        /**
         * BUG FIX: This function now hides all forms before showing the correct one.
         */
        function showAuthForm(role, type) {
            // 1. Hide all forms for this role first to prevent overlap
            document.querySelectorAll(`#${role}-auth .login-form`).forEach(form => form.classList.remove('active'));
            
            // 2. Hide the action buttons
            document.getElementById(`${role}-auth-actions`).classList.remove('active');
            
            // 3. Show the specific form
            document.getElementById(`${role}-${type}-form`).classList.add('active');
        }
        
        // Hide forms and show buttons
        function resetAuthForms(role) {
            // Hide all forms
            document.querySelectorAll(`#${role}-auth .login-form`).forEach(form => form.classList.remove('active'));
            // Show the action buttons
            document.getElementById(`${role}-auth-actions`).classList.add('active');
        }


        // Dynamic Subject Fields
        document.getElementById('subject-count').addEventListener('change', function() {
            const count = parseInt(this.value);
            const container = document.getElementById('subjects-container');
            container.innerHTML = '';
            
            if (count > 0 && count <= 10) {
                for (let i = 1; i <= count; i++) {
                    const subjectDiv = document.createElement('div');
                    subjectDiv.className = 'subject-entry';
                    subjectDiv.innerHTML = `
                        <h4 style="margin: 20px 0 10px; color: var(--primary);">Subject ${i}</h4>
                        <div class="form-group">
                            <label class="form-label">Subject Name</label>
                            <input type="text" class="form-control subject-name" placeholder="Enter subject name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Credits</label>
                            <input type="number" class="form-control subject-credit" min="1" max="10" placeholder="Enter credits" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Subject Type</label>
                            <select class="form-control subject-type" required>
                                <option value="">Select Type</option>
                                <option value="theory">Theory</option>
                                <option value="practical">Practical</option>
                                <option value="theory+practical">Theory + Practical</option>
                                <option value="coding+project">Coding + Project</option>
                            </select>
                        </div>
                    `;
                    container.appendChild(subjectDiv);
                }
            }
        });

        // Student Registration
        function handleStudentRegister() {
            const form = document.getElementById('student-register-form');
            if (!form.checkValidity()) {
                alert('Please fill all required fields');
                form.reportValidity();
                return;
            }
            
            // NEW: Password confirmation check
            const password = document.getElementById('reg-password').value;
            const confirmPassword = document.getElementById('reg-confirm-password').value;
            
            if (password !== confirmPassword) {
                alert('Passwords do not match. Please try again.');
                return;
            }

            const subjects = [];
            const subjectEntries = document.querySelectorAll('#student-register-form .subject-entry');
            if (subjectEntries.length === 0) {
                alert('Please enter subject details');
                return;
            }
            
            let allSubjectsValid = true;
            subjectEntries.forEach(entry => {
                const name = entry.querySelector('.subject-name').value;
                const credit = entry.querySelector('.subject-credit').value;
                const type = entry.querySelector('.subject-type').value;
                
                if (name && credit && type) {
                    subjects.push({ name, credit, type });
                } else {
                    allSubjectsValid = false;
                }
            });
            
            if (!allSubjectsValid || subjects.length === 0) {
                alert('Please fill all subject details correctly.');
                return;
            }
            
            const userData = {
                password: password, // Store the confirmed password
                name: document.getElementById('name').value,
                regNo: document.getElementById('reg-no').value,
                college: document.getElementById('college').value,
                department: document.getElementById('department').value,
                batch: document.getElementById('batch').value,
                semester: document.getElementById('semester').value,
                dob: document.getElementById('dob').value,
                bloodGroup: document.getElementById('blood-group').value,
                mobile: document.getElementById('mobile').value,
                district: document.getElementById('district').value,
                pincode: document.getElementById('pincode').value,
                address: document.getElementById('address').value,
                subjects: subjects
            };
            
            // Store in students array
            let students = db.get('studentsData');
            // Check if regNo already exists
            if (students.some(s => s.regNo === userData.regNo)) {
                alert('Registration failed: This Registration Number is already in use.');
                return;
            }
            
            students.push(userData);
            db.set('studentsData', students);
            
            alert('Registration Successful! Please log in.');
            
            // Switch to Login form after registration
            form.reset();
            document.getElementById('subjects-container').innerHTML = '';
            showAuthForm('student', 'login');
        }

        // Student Login
        function handleStudentLogin() {
            const form = document.getElementById('student-login-form');
            if (!form.checkValidity()) {
                alert('Please fill all required fields');
                form.reportValidity();
                return;
            }
            
            const regNo = document.getElementById('login-reg-no').value;
            const password = document.getElementById('login-password').value;
            
            const students = db.get('studentsData');
            const user = students.find(s => s.regNo === regNo && s.password === password);
            
            if (user) {
                // Login successful
                currentUser = user;
                userRole = 'student';
                localStorage.setItem('currentUser', JSON.stringify(user));
                localStorage.setItem('userRole', 'student');
                
                showDashboard(user, 'student');
            } else {
                alert('Login failed: Invalid Registration Number or Password. Have you registered?');
            }
        }

        // Faculty Registration
        function handleFacultyRegister() {
            const form = document.getElementById('faculty-register-form');
            if (!form.checkValidity()) {
                alert('Please fill all required fields');
                form.reportValidity();
                return;
            }
            
            // NEW: Password confirmation check
            const password = document.getElementById('faculty-reg-password').value;
            const confirmPassword = document.getElementById('faculty-reg-confirm-password').value;

            if (password !== confirmPassword) {
                alert('Passwords do not match. Please try again.');
                return;
            }

            const facultyData = {
                password: password, // Store the confirmed password
                facultyName: document.getElementById('faculty-name').value,
                facultyEmail: document.getElementById('faculty-email').value,
                facultyMobile: document.getElementById('faculty-mobile').value,
                facultyDepartment: document.getElementById('faculty-department').value,
                facultyBatch: document.getElementById('faculty-batch').value,
                facultySubject: document.getElementById('faculty-subject').value
            };
            
            let faculty = db.get('facultyData');
            // Check if name or email already exists
            if (faculty.some(f => f.facultyName === facultyData.facultyName)) {
                 alert('Registration failed: This Name is already in use.');
                return;
            }
            if (faculty.some(f => f.facultyEmail === facultyData.facultyEmail)) {
                 alert('Registration failed: This Email is already in use.');
                return;
            }
            
            faculty.push(facultyData);
            db.set('facultyData', faculty);
            
            alert('Faculty Registration Successful! Please log in.');

            // Switch to Login form after registration
            form.reset();
            showAuthForm('faculty', 'login');
        }

        // Faculty Login
        function handleFacultyLogin() {
            const form = document.getElementById('faculty-login-form');
            if (!form.checkValidity()) {
                alert('Please fill all required fields');
                form.reportValidity();
                return;
            }
            
            const name = document.getElementById('faculty-login-name').value;
            const password = document.getElementById('faculty-login-password').value;
            
            const faculty = db.get('facultyData');
            const user = faculty.find(f => f.facultyName === name && f.password === password);
            
            if (user) {
                // Login successful
                currentUser = user;
                userRole = 'faculty';
                localStorage.setItem('currentUser', JSON.stringify(user));
                localStorage.setItem('userRole', 'faculty');
                
                showDashboard(user, 'faculty');
            } else {
                alert('Login failed: Invalid Name or Password. Have you registered?');
            }
        }


        // Logout
        document.getElementById('logout-btn').addEventListener('click', function() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('userRole');
            currentUser = null;
            userRole = null;
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('login-page').style.display = 'flex';
            document.getElementById('logout-btn').style.display = 'none';
            document.getElementById('sidebar').style.display = 'none';
            
            // Reset forms
            document.querySelectorAll('.login-form').forEach(form => form.reset());
            document.getElementById('subjects-container').innerHTML = '';
            
            // Restore default view
            document.querySelector('.login-tab[data-tab="student"]').classList.add('active');
            document.querySelector('.login-tab[data-tab="faculty"]').classList.remove('active');
            document.getElementById('student-auth').classList.add('active');
            document.getElementById('faculty-auth').classList.remove('active');
            
            // Reset both roles to the button view
            resetAuthForms('student');
            resetAuthForms('faculty');
        });

        // ------------------------------------------
        // PAGE NAVIGATION & RENDERING
        // ------------------------------------------

        // Mobile Sidebar Toggle
        document.getElementById('menu-toggle').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('open');
            const icon = this.querySelector('i');
            icon.classList.toggle('fa-bars');
            icon.classList.toggle('fa-times');
        });

        document.getElementById('sidebar-overlay').addEventListener('click', function() {
            document.getElementById('sidebar').classList.remove('open');
            this.classList.remove('open');
            document.querySelector('#menu-toggle i').classList.remove('fa-times');
            document.querySelector('#menu-toggle i').classList.add('fa-bars');
        });

        // Navigation Listeners
        function attachNavListeners() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    if (window.innerWidth <= 768) {
                        document.getElementById('sidebar').classList.remove('open');
                        document.getElementById('sidebar-overlay').classList.remove('open');
                        document.querySelector('#menu-toggle i').classList.remove('fa-times');
                        document.querySelector('#menu-toggle i').classList.add('fa-bars');
                    }
                    
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    
                    const pageId = this.getAttribute('data-page');
                    navigateToPage(pageId);
                });
            });
        }

        // Central Page Navigation Router
        function navigateToPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            const targetPage = document.getElementById(pageId + '-page');
            
            if (targetPage) {
                // Call the correct render function *before* showing the page
                if (userRole === 'student') {
                    switch(pageId) {
                        case 'subjects': renderStudentSubjects(); break;
                        case 'laboratory': renderStudentLaboratory(); break;
                        case 'projects': renderStudentProjects(); break;
                        case 'co-curricular': renderStudentCoCurricular(); break;
                        case 'sports': renderStudentSports(); break;
                        case 'assignments': renderStudentAssignments(); break;
                        case 'reminders': renderStudentReminders(); break;
                        case 'marklist': renderStudentMarklist(); break; // NEW
                    }
                } else if (userRole === 'faculty') {
                    switch(pageId) {
                        case 'subjects': renderFacultySubjects(); break;
                        case 'laboratory': renderFacultyLaboratory(); break;
                        case 'projects': renderFacultyProjects(); break;
                        case 'assignments': renderFacultyAssignments(); break;
                        case 'reminders': renderFacultyReminders(); break;
                        case 'students': renderStudentsTable(); break;
                        case 'marklist': renderFacultyMarklist(); break; // NEW
                    }
                }
                
                targetPage.classList.add('active');
            }
        }
        
        // "Sync" - Listen for storage changes in other tabs
        window.addEventListener('storage', (event) => {
            // If data changed, refresh the current page's content
            const activeLink = document.querySelector('.nav-link.active');
            if (activeLink) {
                navigateToPage(activeLink.getAttribute('data-page'));
            }
        });

        // ------------------------------------------
        // UTILITY FUNCTIONS
        // ------------------------------------------
        
        // NEW: Handles opening files in-browser or downloading them
        function openFile(file) {
            if (!file || !file.data) {
                alert('File data is missing or corrupt.');
                return;
            }

            try {
                // For PDF, Images, Video, Audio - open in a new tab
                if (file.type === 'application/pdf' || file.type.startsWith('image/') || file.type.startsWith('video/') || file.type.startsWith('audio/')) {
                    const newTab = window.open();
                    let content = '';
                    if (file.type === 'application/pdf') {
                        content = `<embed src="${file.data}" type="application/pdf" width="100%" height="100%">`;
                    } else if (file.type.startsWith('image/')) {
                        content = `<img src="${file.data}" style="max-width: 100%; margin: auto; display: block;">`;
                    } else if (file.type.startsWith('video/')) {
                        content = `<video src="${file.data}" controls autoplay style="width: 100%; max-width: 800px; margin: auto; display: block;">`;
                    } else if (file.type.startsWith('audio/')) {
                        content = `<audio src="${file.data}" controls autoplay style="width: 80%; margin: 20px auto; display: block;">`;
                    }
                    newTab.document.write(`<html><body style="margin:0; background: #333;">${content}</body></html>`);
                    newTab.document.title = file.name;
                } 
                // For all other files (PPT, DOCX, ZIP) - trigger download
                else {
                    const link = document.createElement('a');
                    link.href = file.data;
                    link.download = file.name;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            } catch (e) {
                console.error('Error opening file:', e);
                alert('Could not open file. It might be corrupt or the browser may not support it.');
            }
        }
        
        // NEW: Handler for clicking a file in the "Subjects" or "Laboratory" page
        function handleFileView(materialId) {
            const allMaterials = db.get('subjectMaterials');
            const material = allMaterials.find(m => m.id === materialId);
            if (material && material.file) {
                openFile(material.file);
            } else {
                alert('File not found!');
            }
        }
        
        // NEW: Handler for clicking a file in the "Assignments" page
        function handleAssignmentFileView(assignmentId) {
            const assignments = db.get('assignmentsData');
            const assignment = assignments.find(a => a.id === assignmentId);
            if (assignment && assignment.file) {
                openFile(assignment.file);
            } else {
                alert('File not found!');
            }
        }
        
        
        function calculateAge(dob) {
            const birthDate = new Date(dob);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        function getYearFromSemester(semester) {
            const sem = parseInt(semester);
            if (sem <= 2) return 'I';
            if (sem <= 4) return 'II';
            if (sem <= 6) return 'III';
            if (sem <= 8) return 'IV';
            return 'N/A';
        }

        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            document.getElementById('toast-body').textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000); // Shortened to 3 seconds
        }

        function checkReminders(user) {
            const reminders = db.get('remindersData');
            const unseenReminders = reminders.filter(r => !r.seenBy.includes(user.regNo));
            
            if (unseenReminders.length > 0) {
                const latestReminder = unseenReminders[unseenReminders.length - 1];
                showToast(latestReminder.text);
                
                // Mark as seen
                latestReminder.seenBy.push(user.regNo);
                db.set('remindersData', reminders);
            }
            
            // Check deadlines
            const today = new Date().toISOString().split('T')[0];
            const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0];
            
            reminders.forEach(r => {
                if (r.deadline === tomorrow && !r.deadlineNotified) {
                    showToast(`DEADLINE TOMORROW: ${r.text}`);
                    r.deadlineNotified = true; // Prevent re-notifying
                }
            });
            db.set('remindersData', reminders);
        }

        // File to Base64 (for demo storage in localStorage)
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve({ name: file.name, type: file.type, data: reader.result });
                reader.onerror = error => reject(error);
            });
        }

        // Helper to create a file list item
        function createFileListHTML(files, uploadDate) {
            if (!files || files.length === 0) return '<p>No files uploaded.</p>';
            let html = '<ul class="file-list">';
            files.forEach(file => {
                html += `
                    <li class="file-list-item">
                        <span class="file-info">
                            <i class="fas fa-file-alt"></i> ${file.name}
                        </span>
                        <span class="file-date">Uploaded: ${uploadDate}</span>
                    </li>
                `;
            });
            html += '</ul>';
            return html;
        }

        // Helper to create upload card
        function createUploadCard(id, title, existingData) {
            const filesHTML = existingData ? createFileListHTML(existingData.files, existingData.uploadDate) : '';
            const buttonText = existingData ? 'Edit / Re-upload Files' : 'Upload Files';
            
            return `
                <div class="card upload-card">
                    <h3 class="upload-card-header">${title}</h3>
                    <div id="${id}-current-files">
                        ${filesHTML}
                    </div>
                    <div class="form-group" ${id === 'project' ? '' : 'style="display:none;"'}>
                        <label class="form-label" for="${id}-title">Title</label>
                        <input type="text" class="form-control" id="${id}-title" placeholder="Enter project title" value="${existingData?.title || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Upload Files (Images, Videos, PDFs, etc.)</label>
                        <div class="upload-area">
                            <input type="file" id="${id}-file-input" multiple>
                            <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                            <p>Drag & drop files or click to browse</p>
                        </div>
                        <p id="${id}-file-status" style="margin-top: 10px; color: #6c757d;"></p>
                    </div>
                    <button class="btn btn-primary" id="${id}-upload-btn">
                        <i class="fas fa-upload"></i> ${buttonText}
                    </button>
                </div>
            `;
        }

        // ------------------------------------------
        // FACULTY: PAGE RENDERERS
        // ------------------------------------------
        
        // ------------------------------------------
        // NEW MARKLIST FUNCTIONS (Faculty)
        // ------------------------------------------

        function renderFacultyMarklist() {
            const page = document.getElementById('marklist-page');
            const students = db.get('studentsData');
            const marklistData = db.get('marklistData') || []; // Ensure it's an array
            const facultySubjectName = currentUser.facultySubject;
            
            // Filter students by batch, dept, and faculty's subject
            const filteredStudents = students.filter(s => 
                s.batch === currentUser.facultyBatch && 
                s.department === currentUser.facultyDepartment &&
                s.subjects.some(sub => sub.name.toLowerCase() === facultySubjectName.toLowerCase())
            );

            let html = `
                <div class="page-header">
                    <h1 class="page-title">Marklist</h1>
                    <p class="page-subtitle">Enter scores for your subject: <strong>${facultySubjectName}</strong></p>
                </div>
                <div class="card">
                    <table class="students-table">
                        <thead>
                            <tr>
                                <th>S.No</th>
                                <th>Register Number</th>
                                <th>CIA 1</th>
                                <th>CIA 2</th>
                                <th>Model Exam</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            if (filteredStudents.length === 0) {
                html += '<tr><td colspan="5" style="text-align: center; color: #6c757d;">No students are registered for this subject.</td></tr>';
            } else {
                filteredStudents.forEach((student, index) => {
                    const markId = `${student.regNo}_${facultySubjectName}`;
                    const existingMarks = marklistData.find(m => m.id === markId);
                    
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${student.regNo}</td>
                            <td><input type="text" class="form-control mark-input" data-reg-no="${student.regNo}" data-subject="${facultySubjectName}" data-exam-type="cia1" value="${existingMarks?.cia1 || ''}"></td>
                            <td><input type="text" class="form-control mark-input" data-reg-no="${student.regNo}" data-subject="${facultySubjectName}" data-exam-type="cia2" value="${existingMarks?.cia2 || ''}"></td>
                            <td><input type="text" class="form-control mark-input" data-reg-no="${student.regNo}" data-subject="${facultySubjectName}" data-exam-type="model" value="${existingMarks?.model || ''}"></td>
                        </tr>
                    `;
                });
            }

            html += `</tbody></table></div>`;
            page.innerHTML = html;
            
            // Add event listeners to all inputs
            document.querySelectorAll('#marklist-page .mark-input').forEach(input => {
                input.addEventListener('blur', handleMarkSave); // 'blur' saves when user clicks away
            });
        }
        
        function handleMarkSave(e) {
            const regNo = e.target.dataset.regNo;
            const subject = e.target.dataset.subject;
            const examType = e.target.dataset.examType;
            const value = e.target.value;
            
            let marklistData = db.get('marklistData');
            const markId = `${regNo}_${subject}`;
            let record = marklistData.find(m => m.id === markId);
            
            if (record) {
                // Record exists, update it
                record[examType] = value;
            } else {
                // Record doesn't exist, create it
                const newRecord = {
                    id: markId,
                    studentRegNo: regNo,
                    subjectName: subject,
                    cia1: '',
                    cia2: '',
                    model: ''
                };
                newRecord[examType] = value;
                marklistData.push(newRecord);
            }
            
            db.set('marklistData', marklistData);
            showToast('Mark saved!');
        }

        // Reusable function to render subject upload cards
        function renderSubjectUploadCards(pageId, title, subtitle, subjectFilter) {
            const page = document.getElementById(pageId);
            const students = db.get('studentsData');
            const myStudents = students.filter(s => s.batch === currentUser.facultyBatch && s.department === currentUser.facultyDepartment);
            const subjectMaterials = db.get('subjectMaterials');

            // Get unique subjects (name, type) from students
            const allSubjects = new Map();
            myStudents.forEach(s => {
                s.subjects.forEach(sub => {
                    if (!allSubjects.has(sub.name)) {
                        allSubjects.set(sub.name, sub.type);
                    }
                });
            });

            let html = `
                <div class="page-header">
                    <h1 class="page-title">${title}</h1>
                    <p class="page-subtitle">${subtitle}</p>
                </div>
            `;
            
            let subjectsToRender = Array.from(allSubjects.entries());
            
            // Apply the filter function (if one is provided)
            if (subjectFilter) {
                subjectsToRender = subjectsToRender.filter(subjectFilter);
            }

            if (subjectsToRender.length === 0) {
                html += `
                    <div class="card empty-state">
                        <i class="fas fa-book-dead"></i>
                        <h3>No Relevant Subjects Found</h3>
                        <p>No students in your batch have registered this subject, or it does not match the page criteria.</p>
                    </div>
                `;
            }

            subjectsToRender.forEach(([name, type]) => {
                // Only show materials uploaded by the CURRENT faculty
                const materials = subjectMaterials.filter(m => m.subjectName.toLowerCase() === name.toLowerCase() && m.facultyName === currentUser.facultyName);
                
                let materialsHTML = `
                    <table class="materials-table">
                        <thead><tr><th>File Name</th><th>Note</th><th>Date</th><th>Actions</th></tr></thead>
                        <tbody>
                `;
                if (materials.length === 0) {
                    materialsHTML += '<tr><td colspan="4" style="text-align: center;">You have not uploaded any materials yet.</td></tr>';
                } else {
                    materials.reverse().forEach(m => {
                        materialsHTML += `
                            <tr>
                                <td><a href="#" onclick="handleFileView('${m.id}')">${m.file.name}</a></td>
                                <td class="file-note">${m.note}</td>
                                <td>${m.uploadDate}</td>
                                <td class="actions-cell">
                                    <button class="btn btn-secondary btn-sm edit-material-btn" data-id="${m.id}"><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-warning btn-sm delete-material-btn" data-id="${m.id}"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                        `;
                    });
                }
                materialsHTML += '</tbody></table>';

                html += `
                    <div class="card subject-upload-card">
                        <h3>${name}</h3>
                        <p style="font-size: 0.9rem; color: #6c757d; margin-bottom: 15px;">Type: ${type}</p>
                        
                        <h4 style="margin-top: 15px;">Uploaded Materials</h4>
                        ${materialsHTML}

                        <h4 style="margin-top: 20px;">Upload New Material</h4>
                        <div class="form-group" style="margin-top: 15px;">
                            <label class="form-label">File (Any Type)</label>
                            <input type="file" class="form-control material-file-input" accept="*/*">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Note</label>
                            <input type="text" class="form-control material-note-input" placeholder="e.g., Unit 1 PPT, Lab 1 Manual">
                        </div>
                        <button class="btn btn-primary upload-material-btn" data-subject="${name}">
                            <i class="fas fa-upload"></i> Upload
                        </button>
                    </div>
                `;
            });

            page.innerHTML = html;
            
            // Attach listeners after rendering
            document.querySelectorAll(`#${pageId} .upload-material-btn`).forEach(btn => {
                btn.addEventListener('click', handleMaterialUpload);
            });
            
            // NEW: Add listeners for new edit/delete buttons
            document.querySelectorAll(`#${pageId} .edit-material-btn`).forEach(btn => {
                btn.addEventListener('click', handleMaterialEdit);
            });
            document.querySelectorAll(`#${pageId} .delete-material-btn`).forEach(btn => {
                btn.addEventListener('click', handleMaterialDelete);
            });
        }

        // *** MODIFIED ***
        // Renders the "Subjects Info" page for faculty
        function renderFacultySubjects() {
            const facultySubjectName = currentUser.facultySubject.toLowerCase();
            renderSubjectUploadCards(
                'subjects-page',
                'Subjects Information',
                `Upload materials for your subject: ${currentUser.facultySubject}`,
                // NEW FILTER: Must match the faculty's subject name
                ([name, type]) => name.toLowerCase() === facultySubjectName
            );
        }

        // *** MODIFIED ***
        // Renders the "Laboratory" page for faculty
        function renderFacultyLaboratory() {
            const facultySubjectName = currentUser.facultySubject.toLowerCase();
            renderSubjectUploadCards(
                'laboratory-page',
                'Laboratory Uploads',
                `Upload materials for your lab subject: ${currentUser.facultySubject}`,
                // NEW FILTER: Must be a lab type AND match the faculty's subject name
                ([name, type]) => 
                    (type === 'practical' || type === 'theory+practical') && 
                    name.toLowerCase() === facultySubjectName
            );
        }
        
        // Handles the upload for both subjects and lab pages
        async function handleMaterialUpload(e) {
            const subjectName = e.target.getAttribute('data-subject');
            const card = e.target.closest('.subject-upload-card');
            const fileInput = card.querySelector('.material-file-input');
            const noteInput = card.querySelector('.material-note-input');

            if (fileInput.files.length === 0) {
                alert('Please select a file to upload.');
                return;
            }
            if (!noteInput.value) {
                alert('Please add a note for the file.');
                return;
            }

            const fileData = await fileToBase64(fileInput.files[0]);
            
            const newUpload = {
                id: `mat-${Date.now()}`,
                subjectName: subjectName,
                facultyName: currentUser.facultyName,
                uploadDate: new Date().toLocaleDateString(),
                note: noteInput.value,
                file: fileData
            };

            const materials = db.get('subjectMaterials');
            materials.push(newUpload);
            db.set('subjectMaterials', materials);

            alert('Material uploaded successfully!');
            
            // Refresh the current page
            const activePageId = document.querySelector('.page.active').id;
            if (activePageId === 'subjects-page') {
                renderFacultySubjects();
            } else if (activePageId === 'laboratory-page') {
                renderFacultyLaboratory();
            }
        }

        // *** NEW FUNCTION: Handle Material Edit ***
        function handleMaterialEdit(e) {
            const id = e.currentTarget.getAttribute('data-id');
            const materials = db.get('subjectMaterials');
            const material = materials.find(m => m.id === id);
            
            if (!material) return;
            
            const newNote = prompt('Edit the note for this file:', material.note);
            
            if (newNote !== null && newNote.trim() !== '' && newNote !== material.note) {
                material.note = newNote;
                db.set('subjectMaterials', materials);
                alert('Note updated!');
                // Refresh the current page
                const activePageId = document.querySelector('.page.active').id;
                if (activePageId === 'subjects-page') {
                    renderFacultySubjects();
                } else if (activePageId === 'laboratory-page') {
                    renderFacultyLaboratory();
                }
            }
        }

        // *** NEW FUNCTION: Handle Material Delete ***
        function handleMaterialDelete(e) {
            const id = e.currentTarget.getAttribute('data-id');
            if (confirm('Are you sure you want to delete this material? This cannot be undone.')) {
                let materials = db.get('subjectMaterials');
                materials = materials.filter(m => m.id !== id);
                db.set('subjectMaterials', materials);
                alert('Material deleted.');
                // Refresh the current page
                const activePageId = document.querySelector('.page.active').id;
                if (activePageId === 'subjects-page') {
                    renderFacultySubjects();
                } else if (activePageId === 'laboratory-page') {
                    renderFacultyLaboratory();
                }
            }
        }

        function renderFacultyProjects() {
            const page = document.getElementById('projects-page');
            const projectSubmissions = db.get('projectSubmissions');
            const students = db.get('studentsData');
            
            // Get students in my batch/dept
            const myStudentRegNos = students
                .filter(s => s.batch === currentUser.facultyBatch && s.department === currentUser.facultyDepartment)
                .map(s => s.regNo);
            
            // Filter submissions from my students
            const myStudentSubmissions = projectSubmissions.filter(p => myStudentRegNos.includes(p.studentRegNo));

            let html = `
                <div class="page-header">
                    <h1 class="page-title">Project Submissions</h1>
                    <p class="page-subtitle">View project uploads from students in your batch</p>
                </div>
            `;

            if (myStudentSubmissions.length === 0) {
                html += `
                    <div class="card empty-state">
                        <i class="fas fa-folder-open"></i>
                        <h3>No Projects Submitted</h3>
                        <p>Students from your batch have not submitted any projects yet.</p>
                    </div>
                `;
            } else {
                myStudentSubmissions.forEach(sub => {
                    const student = students.find(s => s.regNo === sub.studentRegNo);
                    html += `
                        <div class="card">
                            <h3 class="upload-card-header">${sub.title}</h3>
                            <p style="margin-bottom: 15px;">
                                <strong>Student:</strong> ${student?.name || 'Unknown'} (${sub.studentRegNo}) <br>
                                <strong>Uploaded on:</strong> ${sub.uploadDate}
                            </p>
                            ${createFileListHTML(sub.files, sub.uploadDate)}
                        </div>
                    `;
                });
            }
            page.innerHTML = html;
        }

        function renderFacultyAssignments() {
            const page = document.getElementById('assignments-page');
            page.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Create Assignment</h1>
                    <p class="page-subtitle">Post a new assignment for your subject: <strong>${currentUser.facultySubject}</strong></p>
                </div>
                <div class="card">
                    <div class="form-group">
                        <label class="form-label" for="assignment-text">Description / Information</label>
                        <textarea class="form-control" id="assignment-text" rows="5" placeholder="Enter assignment details..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Attach File (Optional)</label>
                        <div class="upload-area">
                            <input type="file" id="assignment-file-input" accept="*/*">
                            <div class="upload-icon"><i class="fas fa-file-upload"></i></div>
                            <p>Drag & drop your file or click to browse (any file type)</p>
                        </div>
                        <p id="assignment-file-status" style="margin-top: 10px; color: #6c757d;"></p>
                    </div>
                    <button class="btn btn-primary" id="assignment-upload-btn">
                        <i class="fas fa-paper-plane"></i> Post Assignment
                    </button>
                </div>
                <div class="card">
                    <h3>Posted Assignments</h3>
                    <div id="posted-assignments-list"></div>
                </div>
            `;
            
            // List posted assignments
            const assignments = db.get('assignmentsData');
            const myAssignments = assignments.filter(a => a.facultySubject === currentUser.facultySubject);
            const listEl = document.getElementById('posted-assignments-list');
            
            if(myAssignments.length === 0) {
                listEl.innerHTML = '<p>No assignments posted yet.</p>';
            } else {
                let html = '<table class="assignment-table" style="display: table; overflow: hidden;"><thead><tr><th>Description</th><th>File</th><th>Date</th><th>Actions</th></tr></thead><tbody>';
                myAssignments.reverse().forEach(a => {
                    html += `
                        <tr>
                            <td class="assignment-desc">${a.text}</td>
                            <td>${a.file ? `<a href="#" onclick="handleAssignmentFileView('${a.id}')">${a.file.name}</a>` : 'N/A'}</td>
                            <td>${a.uploadDate}</td>
                            <td class="actions-cell">
                                <button class="btn btn-secondary btn-sm edit-assignment-btn" data-id="${a.id}"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-warning btn-sm delete-assignment-btn" data-id="${a.id}"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
                html += '</tbody></table>';
                listEl.innerHTML = html;
            }

            // Attach event listeners
            document.getElementById('assignment-upload-btn').addEventListener('click', handleAssignmentUpload);
            document.getElementById('assignment-file-input').addEventListener('change', function() {
                if(this.files.length > 0) {
                    document.getElementById('assignment-file-status').textContent = `Selected: ${this.files[0].name}`;
                }
            });

            // NEW: Add listeners for new edit/delete buttons
            document.querySelectorAll(`#posted-assignments-list .edit-assignment-btn`).forEach(btn => {
                btn.addEventListener('click', handleAssignmentEdit);
            });
            document.querySelectorAll(`#posted-assignments-list .delete-assignment-btn`).forEach(btn => {
                btn.addEventListener('click', handleAssignmentDelete);
            });
        }
        
        async function handleAssignmentUpload() {
            const text = document.getElementById('assignment-text').value;
            if (!text) {
                alert('Please enter assignment description.');
                return;
            }
            
            const fileInput = document.getElementById('assignment-file-input');
            let fileData = null;
            if (fileInput.files.length > 0) {
                fileData = await fileToBase64(fileInput.files[0]);
            }
            
            const assignments = db.get('assignmentsData');
            const newAssignment = {
                id: `assign-${Date.now()}`,
                facultySubject: currentUser.facultySubject,
                facultyName: currentUser.facultyName,
                uploadDate: new Date().toLocaleDateString(),
                text: text,
                file: fileData
            };
            
            assignments.push(newAssignment);
            db.set('assignmentsData', assignments);
            
            alert('Assignment posted successfully!');
            document.getElementById('assignment-text').value = '';
            fileInput.value = '';
            document.getElementById('assignment-file-status').textContent = '';
            renderFacultyAssignments(); // Refresh page
        }
        
        // *** NEW FUNCTION: Handle Assignment Edit ***
        function handleAssignmentEdit(e) {
            const id = e.currentTarget.getAttribute('data-id');
            const assignments = db.get('assignmentsData');
            const assignment = assignments.find(a => a.id === id);
            
            if (!assignment) return;
            
            const newText = prompt('Edit the assignment description:', assignment.text);
            
            if (newText !== null && newText.trim() !== '' && newText !== assignment.text) {
                assignment.text = newText;
                db.set('assignmentsData', assignments);
                alert('Assignment updated!');
                renderFacultyAssignments(); // Just refresh this page
            }
        }

        // *** NEW FUNCTION: Handle Assignment Delete ***
        function handleAssignmentDelete(e) {
            const id = e.currentTarget.getAttribute('data-id');
            if (confirm('Are you sure you want to delete this assignment? This will remove it for all students.')) {
                let assignments = db.get('assignmentsData');
                assignments = assignments.filter(a => a.id !== id);
                db.set('assignmentsData', assignments);
                
                // ALSO delete student submissions for this assignment
                let submissions = db.get('assignmentSubmissions');
                submissions = submissions.filter(s => s.assignmentId !== id);
                db.set('assignmentSubmissions', submissions);
                
                alert('Assignment and all related submissions deleted.');
                renderFacultyAssignments(); // Just refresh this page
            }
        }

        function renderFacultyReminders() {
            const page = document.getElementById('reminders-page');
            page.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Send Reminder</h1>
                    <p class="page-subtitle">Send a notification to students in your batch</p>
                </div>
                <div class="card">
                    <div class="form-group">
                        <label class="form-label" for="reminder-text">Reminder Message</label>
                        <textarea class="form-control" id="reminder-text" rows="4" placeholder="Enter message... (e.g., Assignment 1 is due...)" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="reminder-deadline">Deadline (Optional)</label>
                        <input type="date" class="form-control" id="reminder-deadline">
                    </div>
                    <button class="btn btn-primary" id="reminder-send-btn">
                        <i class="fas fa-paper-plane"></i> Send Reminder
                    </button>
                </div>
                <div class="card">
                    <h3>Sent Reminders</h3>
                    <div id="sent-reminders-list"></div>
                </div>
            `;
            
            // List sent reminders
            const reminders = db.get('remindersData');
            const myReminders = reminders.filter(r => r.facultyName === currentUser.facultyName);
            const listEl = document.getElementById('sent-reminders-list');
            
            if(myReminders.length === 0) {
                listEl.innerHTML = '<p>No reminders sent yet.</p>';
            } else {
                let html = '';
                myReminders.reverse().forEach(r => {
                    html += `
                        <div class="reminder-card">
                            <div class="reminder-body">${r.text}</div>
                            <div class="reminder-footer">
                                <span>Sent: ${r.sentDate}</span>
                                ${r.deadline ? `<span class="reminder-deadline">Deadline: ${r.deadline}</span>` : ''}
                            </div>
                        </div>
                    `;
                });
                listEl.innerHTML = html;
            }

            // Attach event listener
            document.getElementById('reminder-send-btn').addEventListener('click', handleReminderSend);
        }

        function handleReminderSend() {
            const text = document.getElementById('reminder-text').value;
            if (!text) {
                alert('Please enter a reminder message.');
                return;
            }
            
            const deadline = document.getElementById('reminder-deadline').value;
            
            const reminders = db.get('remindersData');
            const newReminder = {
                id: `rem-${Date.now()}`,
                facultyName: currentUser.facultyName,
                facultyDept: currentUser.facultyDepartment,
                facultyBatch: currentUser.facultyBatch,
                sentDate: new Date().toLocaleDateString(),
                text: text,
                deadline: deadline || null,
                seenBy: [] // New property to track who has seen it
            };
            
            reminders.push(newReminder);
            db.set('remindersData', reminders);
            
            alert('Reminder sent successfully!');
            document.getElementById('reminder-text').value = '';
            document.getElementById('reminder-deadline').value = '';
            renderFacultyReminders(); // Refresh page
        }

        function renderStudentsTable() {
            const students = db.get('studentsData');
            const facultySubjectName = currentUser.facultySubject.toLowerCase();
            
            // Filter by batch, dept, AND if they have the faculty's subject
            const filteredStudents = students.filter(s => 
                s.batch === currentUser.facultyBatch && 
                s.department === currentUser.facultyDepartment &&
                s.subjects.some(sub => sub.name.toLowerCase() === facultySubjectName)
            );
            
            document.getElementById('students-page-subtitle').textContent = `View students in ${currentUser.facultyBatch} ${currentUser.facultyDepartment} taking ${currentUser.facultySubject}`;
            
            const tbody = document.getElementById('students-tbody');
            tbody.innerHTML = '';
            
            if (filteredStudents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #6c757d;">No students match your criteria.</td></tr>';
                return;
            }
            
            filteredStudents.forEach((student, index) => {
                const age = calculateAge(student.dob);
                const year = getYearFromSemester(student.semester);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${student.regNo}</td>
                    <td>${age}</td>
                    <td>${student.bloodGroup}</td>
                    <td>${student.batch}</td>
                    <td>${year}</td>
                    <td>${student.semester}</td>
                    <td>${student.mobile}</td>
                    <td>${student.address}</td>
                `;
                tbody.appendChild(row);
            });
        }


        // ------------------------------------------
        // STUDENT: PAGE RENDERERS
        // ------------------------------------------
        
        // ------------------------------------------
        // NEW STUDENT MARKLIST FUNCTION
        // ------------------------------------------

        function renderStudentMarklist() {
            const page = document.getElementById('marklist-page');
            const allMarks = db.get('marklistData');
            
            // Filter for only the current student's marks
            const myMarks = allMarks.filter(m => m.studentRegNo === currentUser.regNo);

            let html = `
                <div class="page-header">
                    <h1 class="page-title">Your Marks</h1>
                    <p class="page-subtitle">View your scores for all subjects</p>
                </div>
            `;
            
            if (myMarks.length === 0) {
                html += `
                    <div class="card empty-state">
                        <i class="fas fa-marker"></i>
                        <h3>No Marks Entered</h3>
                        <p>Your faculty has not entered any marks for you yet.</p>
                    </div>
                `;
            } else {
                // Group marks by subject (in case multiple faculty teach)
                // This will show one card per subject
                const subjects = currentUser.subjects.map(s => s.name);
                subjects.forEach(subjectName => {
                    const subjectMarks = myMarks.find(m => m.subjectName.toLowerCase() === subjectName.toLowerCase());
                    
                    if (subjectMarks) {
                        html += `
                            <div class="card">
                                <h3>${subjectMarks.subjectName}</h3>
                                <ul class="mark-list">
                                    <li>
                                        <strong>CIA 1</strong>
                                        <span>${subjectMarks.cia1 || 'Not Entered'}</span>
                                    </li>
                                    <li>
                                        <strong>CIA 2</strong>
                                        <span>${subjectMarks.cia2 || 'Not Entered'}</span>
                                    </li>
                                    <li>
                                        <strong>Model Exam</strong>
                                        <span>${subjectMarks.model || 'Not Entered'}</span>
                                    </li>
                                </ul>
                            </div>
                        `;
                    }
                });
            }
            
            page.innerHTML = html;
        }

        // Reusable function to render subject materials for students
        function renderStudentMaterials(pageId, title, subtitle, subjectFilter) {
            const page = document.getElementById(pageId);
            
            let mySubjects = currentUser.subjects;
            // Apply filter if provided
            if (subjectFilter) {
                mySubjects = mySubjects.filter(subjectFilter);
            }
            
            const allMaterials = db.get('subjectMaterials');
            const allFaculty = db.get('facultyData'); // NEW: Get faculty data

            let html = `
                <div class="page-header">
                    <h1 class="page-title">${title}</h1>
                    <p class="page-subtitle">${subtitle}</p>
                </div>
            `;
            
            if (mySubjects.length === 0) {
                 html += `
                    <div class="card empty-state">
                        <i class="fas fa-folder-open"></i>
                        <h3>No Subjects Found</h3>
                        <p>You are not registered for any subjects of this type.</p>
                    </div>
                `;
                page.innerHTML = html;
                return;
            }

            mySubjects.forEach(subject => {
                
                // NEW: Find the faculty who handles this subject for the student's batch/dept
                const faculty = allFaculty.find(f => 
                    f.facultyDepartment === currentUser.department && 
                    f.facultyBatch === currentUser.batch && 
                    f.facultySubject.toLowerCase() === subject.name.toLowerCase()
                );
                const facultyName = faculty ? faculty.facultyName : 'N/A';
                
                html += `
                    <div class="card">
                        <h3>${subject.name}</h3>
                        <p style="font-size: 0.9rem; color: #6c757d; margin-bottom: 15px;">Handled by: <strong>${facultyName}</strong></p>
                `;
                
                const materials = allMaterials.filter(m => m.subjectName.toLowerCase() === subject.name.toLowerCase());
                
                if (materials.length === 0) {
                    html += '<p style="color: #6c757d; margin-top: 10px;">No materials uploaded for this subject yet.</p>';
                } else {
                    html += `
                        <table class="materials-table">
                            <thead><tr><th>File Name</th><th>Note</th><th>Uploaded by</th><th>Date</th></tr></thead>
                            <tbody>
                    `;
                    materials.reverse().forEach(m => {
                        html += `
                            <tr>
                                <td><a href="#" onclick="handleFileView('${m.id}')">${m.file.name}</a></td>
                                <td class="file-note">${m.note}</td>
                                <td>${m.facultyName}</td>
                                <td>${m.uploadDate}</td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table>';
                }
                html += '</div>';
            });
            
            page.innerHTML = html;
        }

        // Renders the "Subjects" page for students
        function renderStudentSubjects() {
            renderStudentMaterials(
                'subjects-page',
                'Your Subjects',
                'View materials and notes uploaded by your faculty',
                null // No filter
            );
        }

        // Renders the "Laboratory" page for students
        function renderStudentLaboratory() {
            renderStudentMaterials(
                'laboratory-page',
                'Laboratory',
                'View materials for your lab subjects',
                (subject) => subject.type === 'practical' || subject.type === 'theory+practical' // Filter
            );
        }

        function renderStudentProjects() {
            const page = document.getElementById('projects-page');
            page.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Projects</h1>
                    <p class="page-subtitle">Upload and manage your project files</p>
                </div>
            `;
            
            const submissions = db.get('projectSubmissions');
            const mySubmission = submissions.find(s => s.studentRegNo === currentUser.regNo);
            
            page.innerHTML += createUploadCard('project', 'Your Project Submission', mySubmission);
            
            // Attach listener
            document.getElementById('project-upload-btn').addEventListener('click', handleProjectUpload);
            document.getElementById('project-file-input').addEventListener('change', function() {
                if(this.files.length > 0) {
                    document.getElementById('project-file-status').textContent = `${this.files.length} file(s) selected.`;
                }
            });
        }
        
        async function handleProjectUpload() {
            const title = document.getElementById('project-title').value;
            const fileInput = document.getElementById('project-file-input');
            
            if (!title) {
                alert('Please enter a project title.');
                return;
            }
            
            if (fileInput.files.length === 0) {
                // If not uploading new files, check if old ones exist
                const submissions = db.get('projectSubmissions');
                const mySubmission = submissions.find(s => s.studentRegNo === currentUser.regNo);
                if (mySubmission && mySubmission.files.length > 0) {
                    // Just update the title
                    mySubmission.title = title;
                    db.set('projectSubmissions', submissions);
                    alert('Project title updated!');
                    renderStudentProjects();
                    return;
                } else {
                    alert('Please select at least one file to upload.');
                    return;
                }
            }

            let fileList = [];
            for (const file of fileInput.files) {
                fileList.push(await fileToBase64(file));
            }

            const newSubmission = {
                studentRegNo: currentUser.regNo,
                title: title,
                uploadDate: new Date().toLocaleDateString(),
                files: fileList
            };

            let submissions = db.get('projectSubmissions');
            // Remove old submission and add new one
            submissions = submissions.filter(s => s.studentRegNo !== currentUser.regNo);
            submissions.push(newSubmission);
            db.set('projectSubmissions', submissions);

            alert('Project uploaded successfully!');
            renderStudentProjects();
        }

        function renderStudentCoCurricular() {
            const page = document.getElementById('co-curricular-page');
            page.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Co-curricular</h1>
                    <p class="page-subtitle">Upload your certificates and achievements</p>
                </div>
            `;
            const submissions = db.get('coCurricularUploads');
            const mySubmission = submissions.find(s => s.studentRegNo === currentUser.regNo);
            
            page.innerHTML += createUploadCard('cocurricular', 'Your Co-curricular Files', mySubmission);

            document.getElementById('cocurricular-upload-btn').addEventListener('click', handleCoCurricularUpload);
            document.getElementById('cocurricular-file-input').addEventListener('change', function() {
                if(this.files.length > 0) {
                    document.getElementById('cocurricular-file-status').textContent = `${this.files.length} file(s) selected.`;
                }
            });
        }
        
        async function handleCoCurricularUpload() {
             const fileInput = document.getElementById('cocurricular-file-input');
             if (fileInput.files.length === 0) {
                 alert('Please select files to upload.');
                 return;
             }
             
             let fileList = [];
             for (const file of fileInput.files) {
                 fileList.push(await fileToBase64(file));
             }
             
             const newSubmission = {
                 studentRegNo: currentUser.regNo,
                 uploadDate: new Date().toLocaleDateString(),
                 files: fileList
             };
             
             let submissions = db.get('coCurricularUploads');
             submissions = submissions.filter(s => s.studentRegNo !== currentUser.regNo);
             submissions.push(newSubmission);
             db.set('coCurricularUploads', submissions);
             
             alert('Files uploaded successfully!');
             renderStudentCoCurricular();
        }

        function renderStudentSports() {
            const page = document.getElementById('sports-page');
            page.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Sports</h1>
                    <p class="page-subtitle">Upload your sports achievements</p>
                </div>
            `;
            const submissions = db.get('sportsUploads');
            const mySubmission = submissions.find(s => s.studentRegNo === currentUser.regNo);
            
            page.innerHTML += createUploadCard('sports', 'Your Sports Files', mySubmission);

            document.getElementById('sports-upload-btn').addEventListener('click', handleSportsUpload);
            document.getElementById('sports-file-input').addEventListener('change', function() {
                if(this.files.length > 0) {
                    document.getElementById('sports-file-status').textContent = `${this.files.length} file(s) selected.`;
                }
            });
        }

        async function handleSportsUpload() {
             const fileInput = document.getElementById('sports-file-input');
             if (fileInput.files.length === 0) {
                 alert('Please select files to upload.');
                 return;
             }
             
             let fileList = [];
             for (const file of fileInput.files) {
                 fileList.push(await fileToBase64(file));
             }
             
             const newSubmission = {
                 studentRegNo: currentUser.regNo,
                 uploadDate: new Date().toLocaleDateString(),
                 files: fileList
             };
             
             let submissions = db.get('sportsUploads');
             submissions = submissions.filter(s => s.studentRegNo !== currentUser.regNo);
             submissions.push(newSubmission);
             db.set('sportsUploads', submissions);
             
             alert('Files uploaded successfully!');
             renderStudentSports();
        }
        
        function renderStudentAssignments() {
            const page = document.getElementById('assignments-page');
            const studentSubjects = currentUser.subjects.map(s => s.name.toLowerCase());
            
            const allAssignments = db.get('assignmentsData');
            const myAssignments = allAssignments.filter(a => studentSubjects.includes(a.facultySubject.toLowerCase()));
            const mySubmissions = db.get('assignmentSubmissions').filter(s => s.studentRegNo === currentUser.regNo);
            
            let html = `
                <div class="page-header">
                    <h1 class="page-title">Assignments</h1>
                    <p class="page-subtitle">View and submit your assignments</p>
                </div>
                <div class="card">
                    <table class="assignment-table" style="display: table; overflow: hidden;">
                        <thead>
                            <tr>
                                <th>S.No</th>
                                <th>Subject</th>
                                <th>Assignment Details</th>
                                <th>Faculty File</th>
                                <th>Your Submission</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            if (myAssignments.length === 0) {
                html += '<tr><td colspan="5" style="text-align: center;">No assignments posted for your subjects yet.</td></tr>';
            } else {
                myAssignments.reverse().forEach((assign, index) => {
                    const submission = mySubmissions.find(s => s.assignmentId === assign.id);
                    let submissionHTML = `
                        <input type="file" class="assignment-submit-input" data-id="${assign.id}" style="font-size: 0.9rem;">
                        <button class="btn btn-primary" style="padding: 5px 10px; font-size: 0.9rem; margin-top: 5px;" data-id="${assign.id}" onclick="handleAssignmentSubmission(this)">
                            <i class="fas fa-upload"></i> Submit
                        </button>
                    `;
                    
                    if (submission) {
                        submissionHTML = `
                            <div class="file-info" style="font-size: 0.9rem;">
                                <i class="fas fa-check-circle" style="color: green;"></i>
                                ${submission.file.name}
                            </div>
                            <div class="file-date" style="font-size: 0.8rem;">${submission.uploadDate}</div>
                            <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8rem; margin-top: 5px;" data-id="${assign.id}" onclick="handleAssignmentSubmission(this)">
                                <i class="fas fa-edit"></i> Re-submit
                            </button>
                        `;
                    }
                    
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td><strong>${assign.facultySubject}</strong><br><span style="font-size: 0.9rem; color: #6c757d;">by ${assign.facultyName}</span></td>
                            <td class="assignment-desc">${assign.text}</td>
                            <td class="assignment-file">${assign.file ? `<a href="#" onclick="handleAssignmentFileView('${assign.id}')">${assign.file.name}</a>` : 'N/A'}</td>
                            <td>${submissionHTML}</td>
                        </tr>
                    `;
                });
            }
            
            html += '</tbody></table></div>';
            page.innerHTML = html;
        }
        
        async function handleAssignmentSubmission(button) {
            const assignmentId = button.getAttribute('data-id');
            const fileInput = document.querySelector(`.assignment-submit-input[data-id="${assignmentId}"]`);
            
            if (fileInput.files.length === 0) {
                alert('Please select a file to submit.');
                return;
            }
            
            const fileData = await fileToBase64(fileInput.files[0]);
            
            const newSubmission = {
                assignmentId: assignmentId,
                studentRegNo: currentUser.regNo,
                uploadDate: new Date().toLocaleDateString(),
                file: fileData
            };
            
            let submissions = db.get('assignmentSubmissions');
            // Remove old one if it exists
            submissions = submissions.filter(s => !(s.studentRegNo === currentUser.regNo && s.assignmentId === assignmentId));
            submissions.push(newSubmission);
            db.set('assignmentSubmissions', submissions);
            
            alert('Assignment submitted successfully!');
            renderStudentAssignments(); // Refresh page
        }

        function renderStudentReminders() {
            const page = document.getElementById('reminders-page');
            const allReminders = db.get('remindersData');
            
            // Show reminders from faculty in the same batch/dept
            const myReminders = allReminders.filter(r => 
                r.facultyBatch === currentUser.batch && 
                r.facultyDept === currentUser.department
            );

            let html = `
                <div class="page-header">
                    <h1 class="page-title">Reminders</h1>
                    <p class="page-subtitle">View notifications from your faculty</p>
                </div>
            `;
            
            if (myReminders.length === 0) {
                html += `
                    <div class="card empty-state">
                        <i class="fas fa-bell-slash"></i>
                        <h3>No Reminders</h3>
                        <p>You have no reminders from your faculty.</p>
                    </div>
                `;
            } else {
                myReminders.reverse().forEach(r => {
                    html += `
                        <div class="reminder-card">
                            <div class="reminder-body">${r.text}</div>
                            <div class="reminder-footer">
                                <span>Sent by: <strong>${r.facultyName}</strong> on ${r.sentDate}</span>
                                ${r.deadline ? `<span class="reminder-deadline">Deadline: ${r.deadline}</span>` : ''}
                            </div>
                        </div>
                    `;
                });
            }
            page.innerHTML = html;
        }

    </script>
</body>
</html>
